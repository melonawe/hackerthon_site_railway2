<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì¥ì†Œ ê³µìœ </title>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="share.css" />

    <style>
      /* ë²ˆì—­ ë²„íŠ¼ì„ â™¡ / ğŸ“ ì™€ ê°™ì€ ì¤„ì— ë°°ì¹˜ */
      .post-actions-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .post-actions-right {
        display: flex;
        align-items: center;
      }

      /* sample.html ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ ë§ì¶”ê¸° */
      #searchInput {
        flex: 1;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 0.95em;
        margin-right: 8px;
      }
    </style>
  </head>

  <body>
    <!-- =========================
         HEADER (sample.htmlê³¼ ë™ì¼)
    ========================== -->
    <header>
      <div class="title" id="pageTitle">ì¥ì†Œ ê³µìœ </div>

      <div class="header-right" style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
        <nav class="menu-bar" id="menuBar">
          <div class="menu-item" id="menuMain" onclick="location.href='sample.html'">ë©”ì¸</div>
          <div class="menu-item" id="menuVocab" onclick="location.href='vocab.html'">ë‹¨ì–´ì¥</div>
          <div class="menu-item active" id="menuShare" onclick="location.href='share.html'">ì¥ì†Œ ê³µìœ </div>
        </nav>

        <button class="lang-toggle" id="langToggle">JP</button>
      </div>
    </header>

    <!-- =========================
         BODY LAYOUT
    ========================== -->
    <div class="wrap">
      <main class="main">
        <div class="feed-header">
          <div class="feed-header-top">
            <input id="searchInput" placeholder="ì¥ì†Œ/ê²Œì‹œê¸€ ê²€ìƒ‰" />
            <button class="add-question-btn" id="createPostBtn">ê²Œì‹œê¸€ ì‘ì„±</button>
          </div>
          <div id="activeFilter"></div>
        </div>

        <!-- DBì—ì„œ ë°›ì•„ì˜¨ ì¹´ë“œê°€ ë“¤ì–´ê°ˆ ìë¦¬ -->
        <div class="feed" id="feed"></div>
      </main>

      <aside class="sidebar">
        <div class="tag-box">
          <input
            type="text"
            id="tagSearch"
            class="tag-search"
            placeholder="íƒœê·¸ ê²€ìƒ‰"
            oninput="filterTagList()"
          />
          <div id="tagList"></div>
        </div>
      </aside>
    </div>

    <!-- ======================================================
         SCRIPT â€” DB ì—°ë™ + ë²ˆì—­ + ì¢‹ì•„ìš” + íƒœê·¸ í•„í„°
    ======================================================= -->
    <script>
      const API_BASE = "http://localhost:3000";
      const SHARE_LANG_KEY = "SHARE_LANG";

      let posts = [];        // { id, likes, tags, element, text }
      let postStore = {};    // ë²ˆì—­ ì „/í›„ ì €ì¥ { original, translated, isTranslated, element }
      let activeTags = [];
      let searchKeyword = "";

      /****************************************************
       * ìœ í‹¸
       ****************************************************/
      function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[c]));
      }

      function formatDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "";
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function detectLangByText(text) {
        if (!text) return "KR";
        const hangul = (text.match(/[\uac00-\ud7af\u1100-\u11ff\u3130-\u318f]/g) || []).length;
        const kana   = (text.match(/[\u3040-\u30ff]/g) || []).length;
        const kanji  = (text.match(/[\u4e00-\u9fff]/g) || []).length;
        const jap = kana + kanji;
        if (hangul > jap) return "KR";
        if (jap > hangul) return "JP";
        return "KR";
      }

      /****************************************************
       * DBì—ì„œ ì¥ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
       ****************************************************/
      async function loadPlacesFromDB() {
        try {
          const res = await fetch(API_BASE + "/api/places");
          if (!res.ok) {
            console.error("ì¥ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", res.status);
            return;
          }
          const places = await res.json();

          posts = [];
          postStore = {};
          const feed = document.getElementById("feed");
          feed.innerHTML = "";

          places.forEach((p) => {
            const card = createCardElement(p);
            feed.appendChild(card);

            const tagsArr = normalizeTags(p.tags);

            posts.push({
              id: p.id,
              likes: p.like_count || 0,
              tags: tagsArr,
              element: card,
              text:
                ((p.title || "") + " " + (p.description || "") + " " + tagsArr.join(" "))
                  .toLowerCase(),
            });

            postStore[p.id] = {
              original: {
                caption:
                  (p.title || "") +
                  " â€” " +
                  ((p.description || "").split("\n")[0] || ""),
                tags: tagsArr,
              },
              translated: null,
              isTranslated: false,
              element: card,
            };
          });

          renderTagList();
          renderFeed();
          applyLanguageUI();   // ì¹´ë“œ ë§Œë“¤ì–´ì§„ ë’¤ ë²ˆì—­ë²„íŠ¼ í…ìŠ¤íŠ¸ ê°±ì‹ 
        } catch (err) {
          console.error("ì¥ì†Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", err);
        }
      }

      /****************************************************
       * tags ë¬¸ìì—´/ë°°ì—´ ì •ê·œí™”
       ****************************************************/
      function normalizeTags(tags) {
        if (Array.isArray(tags)) {
          return tags.map((t) => String(t).trim()).filter(Boolean);
        }
        if (typeof tags === "string") {
          return tags
            .split(",")
            .map((t) => t.trim())
            .filter(Boolean);
        }
        return [];
      }

      /****************************************************
       * ì¹´ë“œ DOM ìƒì„±
       ****************************************************/
      function createCardElement(p) {
        const card = document.createElement("article");
        card.className = "post-card";
        card.dataset.id = p.id;

        const tagsArr = normalizeTags(p.tags);

        // ì´ë¯¸ì§€ ì˜ì—­
        const imgHtml = p.image_url
          ? `
            <div class="post-image-wrapper">
              <img class="post-image" src="${API_BASE + p.image_url}" alt="${escapeHtml(
                p.title
              )}" />
            </div>`
          : "";

        // ì„¤ëª…ì—ì„œ ì§€ë„ URL í•˜ë‚˜ ì¶”ì¶œ (ìˆì„ ê²½ìš°)
        let mapUrl = "";
        const urlMatch = (p.description || "").match(/https?:\/\/[^\s]+/g);
        if (urlMatch && urlMatch.length > 0) {
          mapUrl = urlMatch[0];
        }

        const caption =
          (p.title || "") +
          " â€” " +
          ((p.description || "").split("\n")[0] || "");

        const tagHtml = tagsArr
          .map((t) => `<span class="post-tag">#${escapeHtml(t)}</span>`)
          .join("");

        card.innerHTML = `
          ${imgHtml}
          <div class="post-body">
            <div class="post-actions-row">
              <div class="post-actions-left">
                <button class="post-action-btn like-btn">â™¡</button>
                ${
                  mapUrl
                    ? `<button class="post-action-btn map-btn">ğŸ“</button>`
                    : ""
                }
              </div>
              <div class="post-actions-right">
                <button class="post-translate-btn">ë²ˆì—­</button>
              </div>
            </div>

            <div class="post-likes" data-like-count="${p.like_count || 0}">
              ì¢‹ì•„ìš” ${p.like_count || 0}ê°œ
            </div>

            <div class="post-caption">${escapeHtml(caption)}</div>

            <div class="post-tags">
              ${tagHtml}
            </div>

            <div class="post-time">ì‘ì„±ì¼: ${formatDate(p.created_at)}</div>
          </div>
        `;

        // ì¢‹ì•„ìš” ë²„íŠ¼
        const likeBtn = card.querySelector(".like-btn");
        likeBtn.addEventListener("click", () => handleLikeClick(p.id));

        // ì§€ë„ ë²„íŠ¼
        if (mapUrl) {
          const mapBtn = card.querySelector(".map-btn");
          mapBtn.addEventListener("click", () => {
            window.open(mapUrl, "_blank");
          });
        }

        // ë²ˆì—­ ë²„íŠ¼
        const translateBtn = card.querySelector(".post-translate-btn");
        translateBtn.addEventListener("click", () => translateDynamicPost(p.id));

        // íƒœê·¸ í´ë¦­
        initTagClicks(card);

        return card;
      }

      /****************************************************
       * ì¢‹ì•„ìš” (ì„œë²„ /api/places/:id/like ì‚¬ìš©)
       ****************************************************/
      async function handleLikeClick(id) {
        try {
          const res = await fetch(`${API_BASE}/api/places/${id}/like`, {
            method: "POST",
          });
          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            alert(data.error || "ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return;
          }

          const target = posts.find((p) => p.id === id);
          if (target) target.likes = data.like_count;

          const card = document.querySelector(`.post-card[data-id="${id}"]`);
          if (card) {
            const likeEl = card.querySelector(".post-likes");
            likeEl.dataset.likeCount = data.like_count;
            likeEl.textContent = `ì¢‹ì•„ìš” ${data.like_count}ê°œ`;
          }

          renderFeed();
        } catch (err) {
          console.error("ì¢‹ì•„ìš” ìš”ì²­ ì˜¤ë¥˜:", err);
          alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /****************************************************
       * ë²ˆì—­ (ë™ì  ì¹´ë“œ)
       ****************************************************/
      async function translateDynamicPost(id) {
        const info = postStore[id];
        if (!info) return;

        const card = info.element;
        const captionEl = card.querySelector(".post-caption");
        const tagsEl = card.querySelector(".post-tags");
        const btn = card.querySelector(".post-translate-btn");

        if (info.isTranslated) {
          // ì›ë¬¸ ë³µì›
          captionEl.textContent = info.original.caption;
          tagsEl.innerHTML = info.original.tags
            .map((t) => `<span class="post-tag">#${escapeHtml(t)}</span>`)
            .join("");
          info.isTranslated = false;
          initTagClicks(card);
          applyLanguageUI();  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì–¸ì–´ ë§ì¶”ê¸°
          renderFeed();
          return;
        }

        const lines = [info.original.caption, ...info.original.tags];
        const detected = detectLangByText(lines.join("\n"));
        const targetLang = detected === "KR" ? "JA" : "KO";

        try {
          const res = await fetch(API_BASE + "/translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: lines.join("\n"), target_lang: targetLang }),
          });
          const data = await res.json();

          if (!data || !data.translations || !data.translations[0]) {
            throw new Error("ë²ˆì—­ ì‘ë‹µ ì˜¤ë¥˜");
          }

          const all = data.translations[0].text.split("\n");
          const newCaption = all[0];
          const newTags = all.slice(1);

          captionEl.textContent = newCaption;
          tagsEl.innerHTML = newTags
            .map((t) => `<span class="post-tag">#${escapeHtml(t)}</span>`)
            .join("");

          info.translated = { caption: newCaption, tags: newTags };
          info.isTranslated = true;

          // posts ë°°ì—´ íƒœê·¸ë„ ì—…ë°ì´íŠ¸
          const target = posts.find((p) => p.id === id);
          if (target) {
            target.tags = newTags.map((t) => t.trim());
            target.text =
              (info.original.caption + " " + target.tags.join(" ")).toLowerCase();
          }

          initTagClicks(card);
          applyLanguageUI(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ "ì›ë¬¸ ë³´ê¸°" ë“±
          renderFeed();
        } catch (err) {
          console.error("ë²ˆì—­ ì˜¤ë¥˜:", err);
          alert("ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /****************************************************
       * íƒœê·¸ í´ë¦­ / í•„í„° / ê²€ìƒ‰
       ****************************************************/
      function initTagClicks(card) {
        card.querySelectorAll(".post-tag").forEach((el) => {
          const tagText = el.textContent.replace("#", "").trim();
          el.style.cursor = "pointer";
          el.onclick = () => onTagClicked(tagText);
        });
      }

      function onTagClicked(tag) {
        const idx = activeTags.indexOf(tag);
        if (idx > -1) activeTags.splice(idx, 1);
        else activeTags.push(tag);
        renderFeed();
      }

      function renderFeed() {
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        let list = posts.slice();

        if (searchKeyword) {
          list = list.filter((p) => p.text.includes(searchKeyword.toLowerCase()));
        }
        if (activeTags.length > 0) {
          list = list.filter((p) => activeTags.every((t) => p.tags.includes(t)));
        }

        // ì¢‹ì•„ìš” ë§ì€ ìˆœ + id ë‚´ë¦¼ì°¨ìˆœ
        list.sort((a, b) => {
          if (b.likes !== a.likes) return b.likes - a.likes;
          return b.id - a.id;
        });

        list.forEach((p) => feed.appendChild(p.element));

        renderActiveFilter();
        renderTagList();
      }

      function renderActiveFilter() {
        const box = document.getElementById("activeFilter");
        box.innerHTML = activeTags
          .map((tag) => `<span class="active-tag-pill">#${escapeHtml(tag)}</span>`)
          .join("");
      }

      function renderTagList() {
        const tagList = document.getElementById("tagList");
        const counts = {};

        posts.forEach((p) => {
          (p.tags || []).forEach((t) => {
            counts[t] = (counts[t] || 0) + 1;
          });
        });

        const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);

        tagList.innerHTML = entries
          .map(
            ([tag, count]) => `
              <div class="tag-item" data-tag-name="${escapeHtml(tag)}" onclick="onTagClicked('${escapeHtml(
              tag
            )}')">
                <div>#${escapeHtml(tag)}</div>
                <div>(${count})</div>
              </div>
            `
          )
          .join("");

        filterTagList(); // ê²€ìƒ‰ì–´ ì ìš©
      }

      function filterTagList() {
        const q = document.getElementById("tagSearch").value.toLowerCase();
        document.querySelectorAll("#tagList .tag-item").forEach((item) => {
          const name = (item.getAttribute("data-tag-name") || "").toLowerCase();
          item.style.display = name.includes(q) ? "flex" : "none";
        });
      }

      /****************************************************
       * ì–¸ì–´ UI í† ê¸€ (í—¤ë”/ë²„íŠ¼/ë²ˆì—­ ë²„íŠ¼)
       ****************************************************/
      const I18N_UI = {
        KR: {
          pageTitle: "ì¥ì†Œ ê³µìœ ",
          search: "ì¥ì†Œ/ê²Œì‹œê¸€ ê²€ìƒ‰",
          create: "ê²Œì‹œê¸€ ì‘ì„±",
          menu_main: "ë©”ì¸",
          menu_vocab: "ë‹¨ì–´ì¥",
          menu_share: "ì¥ì†Œ ê³µìœ ",
          translate_btn: "ë²ˆì—­",
          translate_back: "ì›ë¬¸ ë³´ê¸°",
        },
        JP: {
          pageTitle: "å ´æ‰€ã‚·ã‚§ã‚¢",
          search: "å ´æ‰€/æŠ•ç¨¿æ¤œç´¢",
          create: "æŠ•ç¨¿ä½œæˆ",
          menu_main: "ãƒ¡ã‚¤ãƒ³",
          menu_vocab: "å˜èªå¸³",
          menu_share: "å ´æ‰€å…±æœ‰",
          translate_btn: "ç¿»è¨³",
          translate_back: "åŸæ–‡è¡¨ç¤º",
        },
      };

      function applyLanguageUI() {
        const lang = localStorage.getItem(SHARE_LANG_KEY) || "KR";
        const T = I18N_UI[lang];

        document.getElementById("pageTitle").textContent = T.pageTitle;
        document.getElementById("searchInput").placeholder = T.search;
        document.getElementById("createPostBtn").textContent = T.create;
        document.getElementById("menuMain").textContent = T.menu_main;
        document.getElementById("menuVocab").textContent = T.menu_vocab;
        document.getElementById("menuShare").textContent = T.menu_share;

        // ë²ˆì—­ ë²„íŠ¼ í…ìŠ¤íŠ¸ (ë²ˆì—­ ì•ˆ ëœ ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ)
        document.querySelectorAll(".post-translate-btn").forEach((btn) => {
          const card = btn.closest(".post-card");
          const id = Number(card.dataset.id);
          const info = postStore[id];
          if (info && info.isTranslated) {
            btn.textContent = T.translate_back;
          } else {
            btn.textContent = T.translate_btn;
          }
        });

        // ì˜¤ë¥¸ìª½ ìƒë‹¨ í† ê¸€ ë²„íŠ¼ì—ëŠ” "ë°”ë€” ì–¸ì–´" í‘œì‹œ
        document.getElementById("langToggle").textContent =
          lang === "KR" ? "JP" : "KR";
      }

      /****************************************************
       * INIT
       ****************************************************/
      document.addEventListener("DOMContentLoaded", () => {
        // ì–¸ì–´ ì´ˆê¸°ê°’
        if (!localStorage.getItem(SHARE_LANG_KEY)) {
          localStorage.setItem(SHARE_LANG_KEY, "KR");
        }
        applyLanguageUI();

        // ì–¸ì–´ í† ê¸€ ë²„íŠ¼
        document.getElementById("langToggle").addEventListener("click", () => {
          const cur = localStorage.getItem(SHARE_LANG_KEY) || "KR";
          localStorage.setItem(SHARE_LANG_KEY, cur === "KR" ? "JP" : "KR");
          applyLanguageUI();
        });

        // ê²Œì‹œê¸€ ì‘ì„± ë²„íŠ¼
        document
          .getElementById("createPostBtn")
          .addEventListener("click", () => {
            location.href = "create_post.html";
          });

        // ê²€ìƒ‰
        document
          .getElementById("searchInput")
          .addEventListener("input", (e) => {
            searchKeyword = e.target.value;
            renderFeed();
          });

        // DBì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadPlacesFromDB();
      });
    </script>
  </body>
</html>
